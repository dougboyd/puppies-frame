<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Ash & Rosie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }

        .slideshow {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            -webkit-transition: opacity 1.5s ease-in-out;
            transition: opacity 1.5s ease-in-out;
        }

        .slide.active {
            opacity: 1;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            color: #fff;
            font-family: -apple-system, Helvetica, Arial, sans-serif;
            font-size: 24px;
            text-align: center;
        }

        .error {
            color: #ff6b6b;
        }

        .hide-cursor {
            cursor: none;
        }

        /* Popup menu overlay */
        .menu-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .menu-overlay.visible {
            display: block;
        }

        .menu {
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            background: #222;
            border-radius: 16px;
            padding: 8px;
            width: 280px;
        }

        .menu-btn {
            display: block;
            width: 100%;
            padding: 18px 24px;
            margin: 8px 0;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-family: -apple-system, Helvetica, Arial, sans-serif;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .menu-btn-like {
            background: #2d8a4e;
            color: #fff;
        }

        .menu-btn-hide {
            background: #c0392b;
            color: #fff;
        }

        .menu-btn-cancel {
            background: #444;
            color: #aaa;
        }

        .menu-btn:active {
            opacity: 0.7;
        }

        /* Navigation tap zones */
        .nav-zone {
            position: absolute;
            top: 0;
            height: 100%;
            z-index: 10;
        }

        .nav-left {
            left: 0;
            width: 20%;
        }

        .nav-right {
            right: 0;
            width: 20%;
        }

        .nav-center {
            left: 20%;
            width: 60%;
        }
    </style>
</head>
<body>
    <div class="slideshow">
        <div id="slide1" class="slide"></div>
        <div id="slide2" class="slide"></div>
        <div id="navLeft" class="nav-zone nav-left"></div>
        <div id="navCenter" class="nav-zone nav-center"></div>
        <div id="navRight" class="nav-zone nav-right"></div>
        <div id="loading" class="loading">Loading photos...</div>
    </div>

    <div id="menuOverlay" class="menu-overlay">
        <div class="menu">
            <button id="btnLike" class="menu-btn menu-btn-like">I Like This</button>
            <button id="btnHide" class="menu-btn menu-btn-hide">I Don't Want To See This</button>
            <button id="btnCancel" class="menu-btn menu-btn-cancel">Cancel</button>
        </div>
    </div>

    <script>
        (function() {
            var CONFIG = {
                slideInterval: 10000,
                transitionDuration: 1500
            };

            var photos = [];       // [{url, weight}, ...]
            var currentPhoto = null;
            var currentSlide = 1;
            var slideTimer = null;
            var menuOpen = false;
            var history = [];      // photos we've shown, for going back
            var historyIndex = -1;

            // Weighted random pick
            function pickWeightedRandom() {
                if (photos.length === 0) return null;
                if (photos.length === 1) return photos[0];

                var totalWeight = 0;
                var i;
                for (i = 0; i < photos.length; i++) {
                    totalWeight += photos[i].weight;
                }

                var r = Math.random() * totalWeight;
                var cumulative = 0;
                for (i = 0; i < photos.length; i++) {
                    cumulative += photos[i].weight;
                    if (r < cumulative) {
                        return photos[i];
                    }
                }

                return photos[photos.length - 1];
            }

            function fetchPhotos(callback) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/api/photos', true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                var data = JSON.parse(xhr.responseText);
                                callback(null, data);
                            } catch (e) {
                                callback('Failed to parse photo list', null);
                            }
                        } else {
                            callback('Failed to load photos: ' + xhr.status, null);
                        }
                    }
                };
                xhr.onerror = function() {
                    callback('Network error', null);
                };
                xhr.send();
            }

            function postAction(endpoint, photo, callback) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', endpoint, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        callback(xhr.status === 200);
                    }
                };
                xhr.send(JSON.stringify({photo: photo}));
            }

            function preloadImage(url, callback) {
                var img = new Image();
                img.onload = function() {
                    if (callback) callback(null, url);
                };
                img.onerror = function() {
                    if (callback) callback('Failed to load image', null);
                };
                img.src = url;
            }

            function showPhoto(photo, autoAdvance) {
                currentPhoto = photo;

                var nextSlide = currentSlide === 1 ? 2 : 1;
                var nextEl = document.getElementById('slide' + nextSlide);
                var currentEl = document.getElementById('slide' + currentSlide);

                nextEl.style.backgroundImage = 'url(' + photo.url + ')';
                nextEl.className = 'slide active';
                currentEl.className = 'slide';
                currentSlide = nextSlide;

                clearTimeout(slideTimer);
                if (autoAdvance !== false) {
                    slideTimer = setTimeout(showNextPhoto, CONFIG.slideInterval);
                }
            }

            function showNextPhoto() {
                if (photos.length === 0) return;

                var pick = pickWeightedRandom();
                // Avoid showing the same photo twice in a row
                if (photos.length > 1 && currentPhoto && pick.url === currentPhoto.url) {
                    pick = pickWeightedRandom();
                }

                // Trim future history if we navigated back then go forward
                if (historyIndex < history.length - 1) {
                    history = history.slice(0, historyIndex + 1);
                }
                history.push(pick);
                historyIndex = history.length - 1;

                showPhoto(pick, true);
            }

            function showPrevPhoto() {
                if (historyIndex <= 0) return;
                historyIndex--;
                showPhoto(history[historyIndex], true);
            }

            function skipForward() {
                if (historyIndex < history.length - 1) {
                    // There's forward history, use it
                    historyIndex++;
                    showPhoto(history[historyIndex], true);
                } else {
                    // No forward history, pick a new random
                    showNextPhoto();
                }
            }

            // Menu handling
            function showMenu() {
                if (menuOpen) return;
                menuOpen = true;
                clearTimeout(slideTimer);
                document.getElementById('menuOverlay').className = 'menu-overlay visible';
            }

            function hideMenu() {
                menuOpen = false;
                document.getElementById('menuOverlay').className = 'menu-overlay';
                slideTimer = setTimeout(showNextPhoto, CONFIG.slideInterval);
            }

            function handleLike() {
                if (!currentPhoto) return;
                postAction('/api/like', currentPhoto.url, function(ok) {
                    if (ok) {
                        currentPhoto.weight += 1;
                    }
                });
                hideMenu();
            }

            function handleHide() {
                if (!currentPhoto) return;
                var photoToHide = currentPhoto.url;
                postAction('/api/hide', photoToHide, function() {});

                // Remove from local array
                for (var i = 0; i < photos.length; i++) {
                    if (photos[i].url === photoToHide) {
                        photos.splice(i, 1);
                        break;
                    }
                }

                hideMenu();
                // Show next photo immediately
                clearTimeout(slideTimer);
                if (photos.length > 0) {
                    showNextPhoto();
                } else {
                    showError('No photos left');
                }
            }

            function showError(message) {
                var loadingEl = document.getElementById('loading');
                loadingEl.style.display = '';
                loadingEl.className = 'loading error';
                loadingEl.innerHTML = message + '<br><br>Tap to retry';
                document.body.onclick = function() {
                    loadingEl.className = 'loading';
                    loadingEl.innerHTML = 'Loading photos...';
                    document.body.onclick = null;
                    init();
                };
            }

            function init() {
                fetchPhotos(function(err, data) {
                    if (err) {
                        showError(err);
                        return;
                    }

                    if (data.length === 0) {
                        showError('No photos found');
                        return;
                    }

                    document.getElementById('loading').style.display = 'none';
                    photos = data;
                    showNextPhoto();

                    // Navigation tap zones
                    document.getElementById('navLeft').onclick = function(e) {
                        e.stopPropagation();
                        if (!menuOpen) {
                            clearTimeout(slideTimer);
                            showPrevPhoto();
                        }
                    };

                    document.getElementById('navCenter').onclick = function(e) {
                        e.stopPropagation();
                        if (!menuOpen) {
                            showMenu();
                        }
                    };

                    document.getElementById('navRight').onclick = function(e) {
                        e.stopPropagation();
                        if (!menuOpen) {
                            clearTimeout(slideTimer);
                            skipForward();
                        }
                    };

                    // Keyboard navigation
                    document.onkeydown = function(e) {
                        var key = e.keyCode || e.which;
                        if (menuOpen) {
                            // Escape to dismiss menu
                            if (key === 27) hideMenu();
                            return;
                        }
                        if (key === 37) {        // Left arrow
                            clearTimeout(slideTimer);
                            showPrevPhoto();
                        } else if (key === 39) { // Right arrow
                            clearTimeout(slideTimer);
                            skipForward();
                        }
                    };

                    // Menu button handlers
                    document.getElementById('btnLike').onclick = function(e) {
                        e.stopPropagation();
                        handleLike();
                    };
                    document.getElementById('btnHide').onclick = function(e) {
                        e.stopPropagation();
                        handleHide();
                    };
                    document.getElementById('btnCancel').onclick = function(e) {
                        e.stopPropagation();
                        hideMenu();
                    };

                    // Tap overlay background to dismiss
                    document.getElementById('menuOverlay').onclick = function() {
                        hideMenu();
                    };

                    // Hide cursor after 3 seconds of no movement
                    var cursorTimer;
                    document.body.onmousemove = function() {
                        document.body.className = '';
                        clearTimeout(cursorTimer);
                        cursorTimer = setTimeout(function() {
                            document.body.className = 'hide-cursor';
                        }, 3000);
                    };
                });
            }

            if (document.readyState === 'complete') {
                init();
            } else {
                window.onload = init;
            }
        })();
    </script>
</body>
</html>
